<!DOCTYPE html>
<html lang="en" ng-app="deviceApp">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="https://ajax.googleapis.com/ajax/libs/angularjs/1.8.2/angular.min.js"></script>
    <title>Device Management System</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            line-height: 1.6;
            background-color: #f4f4f4;
            color: #333;
        }

        .container {
            width: 90%;
            max-width: 1200px;
            margin: 2rem auto;
            background-color: white;
            padding: 2rem;
            box-shadow: 0 6px 12px rgba(0, 0, 0, 0.08);
            border-radius: 10px;
        }

        h1 {
            text-align: center;
            color: #2c3e50;
            margin-bottom: 1.5rem;
            font-weight: 600;
        }

        .filter-container {
            display: flex;
            gap: 0.75rem;
            margin-bottom: 1.5rem;
            align-items: center;
        }

        .filter-input,
        .device-selector select {
            flex-grow: 1;
            padding: 0.75rem;
            border: 1px solid #e0e0e0;
            border-radius: 6px;
            font-size: 0.95rem;
            transition: border-color 0.3s ease, box-shadow 0.3s ease;
            outline: none;
        }

            .filter-input:focus,
            .device-selector select:focus {
                border-color: #3498db;
                box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.15);
            }

        .filter-button,
        .action-button {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            padding: 0.75rem 1.25rem;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            transition: background-color 0.3s ease, transform 0.1s ease, box-shadow 0.3s ease;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .filter-button {
            background-color: #3498db;
            color: white;
            margin-left: 0.5rem;
        }

            .filter-button:hover {
                background-color: #2980b9;
                transform: translateY(-2px);
                box-shadow: 0 4px 6px rgba(0, 0, 0, 0.15);
            }

        .add-button {
            background-color: #2ecc71;
            color: white;
        }

            .add-button:hover {
                background-color: #27ae60;
            }

        #deviceTable {
            width: 100%;
            border-collapse: collapse;
        }

            #deviceTable th,
            #deviceTable td {
                border: 1px solid #ddd;
                padding: 1rem;
                text-align: left;
            }

            #deviceTable th {
                background-color: #f2f2f2;
                font-weight: bold;
            }

            #deviceTable tr:nth-child(even) {
                background-color: #f9f9f9;
            }

            #deviceTable tr:hover {
                background-color: #f5f5f5;
            }

        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0, 0, 0, 0.4);
        }

        .modal-content {
            background-color: #fefefe;
            margin: 10% auto;
            padding: 20px;
            border: 1px solid #888;
            width: 50%;
            max-width: 500px;
            border-radius: 8px;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }

        .close {
            color: #aaa;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
        }

            .close:hover {
                color: black;
            }

        .form-group {
            margin-bottom: 1rem;
        }

            .form-group label {
                display: block;
                margin-bottom: 0.5rem;
            }

            .form-group input {
                width: 100%;
                padding: 0.75rem;
                border: 1px solid #ddd;
                border-radius: 4px;
            }

        .form-actions {
            display: flex;
            justify-content: flex-end;
            gap: 0.5rem;
        }

        .no-data {
            text-align: center;
            padding: 1rem;
            color: #7f8c8d;
        }
        nav {
            background-color: #2c3e50; /* Dark blue-gray background */
            padding: 10px 20px;
            display: flex;
            gap: 20px;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

            nav a {
                color: #ecf0f1; /* Light gray text */
                text-decoration: none;
                font-weight: 600;
                padding: 8px 12px;
                border-radius: 4px;
                transition: background-color 0.3s ease, color 0.3s ease;
            }

                nav a:hover,
                nav a:focus {
                    background-color: #3498db; /* Bright blue on hover */
                    color: white;
                    outline: none;
                }

                nav a:active {
                    background-color: #2980b9; /* Darker blue on click */
                    color: white;
                }
    </style>
</head>

<body ng-app="deviceApp" ng-controller="deviceController">
    <nav>
        <a href="Device.html">Device</a>
        <a href="Phone.html">Phone</a>
        <a href="clients.html">Clients</a>
        <a href="Reservation.html">Reservation</a>
        <a href="PhoneNumbersReport.html">Phone Numbers Report</a>
    </nav>
    <div class="container">

        <h1>Device Management System</h1>

        <div class="filter-container">
            <input type="text" id="nameFilter" class="filter-input" placeholder="Filter by Device Name">
            <device-selector selected-device="selectedDevice"></device-selector>
            <button id="applyFilter" class="filter-button" ng-click="applyFilters()">Apply Filter</button>
            <button id="addDeviceBtn" class="action-button add-button" ng-click="openModal('add')">Add Device</button>
        </div>

        <table id="deviceTable">
            <thead>
                <tr>
                    <th>ID</th>
                    <th>Device Name</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody id="deviceTableBody">
            </tbody>
        </table>

        <div id="noDataMessage" class="no-data" style="display:none;">
            <p>No devices found matching the criteria.</p>
        </div>

        <div id="deviceModal" class="modal">
            <div class="modal-content">
                <div class="modal-header">
                    <h2 id="modalTitle">Add New Device</h2>
                    <span class="close" id="closeModal">&times;</span>
                </div>
                <form id="deviceForm">
                    <input type="hidden" id="deviceId">
                    <div class="form-group">
                        <label for="deviceName">Device Name:</label>
                        <input type="text" id="deviceName" required>
                    </div>
                    <div class="form-actions">
                        <button type="submit" class="action-button add-button">Save</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <script>
        angular.module('deviceApp', [])
            .directive('deviceSelector', function ($http) {
                return {
                    restrict: 'E',
                    replace: true,
                    template: `
                                        <div class="device-selector">
                                            <select
                                                ng-model="selectedDevice"
                                                ng-options="device.Id as device.Name for device in devices"
                                                ng-change="onDeviceSelect()"
                                                class="form-control">
                                                <option value="">Select Device</option>
                                            </select>
                                        </div>
                                    `,
                    scope: {
                        selectedDevice: '='
                    },
                    link: function (scope, element, attrs) {
                        scope.devices = [];

                        function fetchDevices() {
                            $http.get('/api/Devices')
                                .then(function (response) {
                                    scope.devices = response.data;
                                })
                                .catch(function (error) {
                                    console.error('Error fetching devices:', error);
                                });
                        }

                        fetchDevices();

                        scope.onDeviceSelect = function () {
                            const $scope = angular.element(document.body).scope();
                            $scope.applyFilters();
                        };
                    }
                };
            })
            .controller('deviceController', function ($scope, $http) {
                $scope.selectedDevice = null;
                $scope.devices = [];
                $scope.filteredDevices = [];
                $scope.currentFilters = {
                    name: '',
                    selectedDevice: null
                };

                function fetchDevices() {
                    $http.get('/api/Devices')
                        .then(function (response) {
                            if (response && response.data) {
                                $scope.devices = response.data;
                                $scope.applyFilters();
                            } else {
                                console.error('API returned invalid data:', response);
                            }
                        })
                        .catch(function (error) {
                            console.error('Error fetching devices:', error);
                        });
                }

                $scope.applyFilters = function () {
                    $scope.currentFilters.name = document.getElementById('nameFilter').value.trim();
                    $scope.currentFilters.selectedDevice = $scope.selectedDevice;

                    $scope.filteredDevices = $scope.devices.filter(device => {
                        const nameMatch = device.Name.toLowerCase().includes($scope.currentFilters.name.toLowerCase());
                        const deviceMatch = !$scope.currentFilters.selectedDevice || device.Id === $scope.currentFilters.selectedDevice;
                        return nameMatch && deviceMatch;
                    });

                    updateDeviceTable();
                };

                function updateDeviceTable() {
                    const deviceTableBody = document.getElementById('deviceTableBody');
                    deviceTableBody.innerHTML = '';

                    if ($scope.filteredDevices.length === 0) {
                        document.getElementById('noDataMessage').style.display = 'block';
                        return;
                    }

                    document.getElementById('noDataMessage').style.display = 'none';

                    $scope.filteredDevices.forEach(device => {
                        const row = document.createElement('tr');
                        row.innerHTML = `
                                    <td>${device.Id}</td>
                                    <td>${device.Name}</td>
                                    <td>
                                        <button class="action-button" onclick="openModal('edit', ${device.Id})">Edit</button>
                                        <button class="action-button" onclick="deleteDevice(${device.Id})">Delete</button>
                                    </td>
                                `;
                        deviceTableBody.appendChild(row);
                    });
                }

                $scope.addDevice = function (deviceData) {
                    return $http.post('/api/Devices', deviceData)
                        .then(function (response) {
                            return $http.get('/api/Devices');
                        })
                        .then(function (response) {
                            $scope.devices = response.data;
                            $scope.applyFilters();
                        })
                        .catch(function (error) {
                            console.error('Error adding device:', error);
                            throw error;
                        });
                };

                $scope.updateDevice = function (deviceData) {
                    return $http.put(`/api/Devices/${deviceData.Id}`, deviceData)
                        .then(function (response) {
                            const index = $scope.devices.findIndex(d => d.Id === deviceData.Id);
                            if (index !== -1) {
                                $scope.devices[index] = response.data;
                                $scope.applyFilters();
                            }
                        })
                        .catch(function (error) {
                            console.error('Error updating device:', error);
                            throw error;
                        });
                };

                $scope.deleteDevice = function (id) {
                    return $http.delete(`/api/Devices/${id}`)
                        .then(function () {
                            $scope.devices = $scope.devices.filter(d => d.Id !== id);
                            $scope.applyFilters();
                        })
                        .catch(function (error) {
                            console.error('Error deleting device:', error);
                            throw error;
                        });
                };

                $scope.openModal = function (action, id = null) {
                    if (action === 'add') {
                        document.getElementById('modalTitle').textContent = 'Add New Device';
                        document.getElementById('deviceForm').reset();
                        document.getElementById('deviceId').value = '';
                    } else if (action === 'edit') {
                        document.getElementById('modalTitle').textContent = 'Edit Device';
                        fetchDeviceDetails(id);
                    }
                    document.getElementById('deviceModal').style.display = 'block';
                };

                async function fetchDeviceDetails(id) {
                    try {
                        const response = await fetch(`/api/Devices/${id}`);
                        if (!response.ok) throw new Error('Failed to fetch device details');

                        const device = await response.json();
                        document.getElementById('deviceId').value = device.Id;
                        document.getElementById('deviceName').value = device.Name;
                    } catch (error) {
                        console.error('Error fetching device details:', error);
                        closeModal();
                    }
                }

                function closeModal() {
                    document.getElementById('deviceModal').style.display = 'none';
                }

                document.getElementById('closeModal').addEventListener('click', closeModal);
                document.getElementById('deviceForm').addEventListener('submit', function (e) {
                    e.preventDefault();

                    const deviceData = {
                        Id: document.getElementById('deviceId').value ? parseInt(document.getElementById('deviceId').value) : 0,
                        Name: document.getElementById('deviceName').value
                    };

                    if (deviceData.Id) {
                        $scope.updateDevice(deviceData)
                            .then(() => {
                                closeModal();
                                $scope.$apply();
                            })
                            .catch(error => {
                                console.error('Update error:', error);
                            });
                    } else {
                        $scope.addDevice(deviceData)
                            .then(() => {
                                closeModal();
                                $scope.$apply();
                            })
                            .catch(error => {
                                console.error('Add error:', error);
                            });
                    }
                });

                fetchDevices();
            });

        function deleteDevice(id) {
            const $scope = angular.element(document.body).scope();

            if (confirm('Are you sure you want to delete this device?')) {
                $scope.deleteDevice(id)
                    .then(() => {
                        $scope.$apply();
                    })
                    .catch(error => {
                        console.error('Delete error:', error);
                    });
            }
        }

        function openModal(action, id = null) {
            const $scope = angular.element(document.body).scope();
            $scope.openModal(action, id);
            $scope.$apply();
        }
    </script>
</body>
</html>